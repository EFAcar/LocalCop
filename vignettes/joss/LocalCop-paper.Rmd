---
title: 'LocalCop: An R package for local likelihood inference for conditional copulas'
tags:
  - R
  - C++
  - copula
  - local likelihood
  - covariate effect
authors:
  - name: Elif Fidan Acar
    orcid: 
    affiliation: "1, 2" # (Multiple affiliations must be quoted)
  - name: Martin Lysy
    orcid: 
    affiliation: 3
  - name: Alan Kuchinsky
    orcid: 
    affiliation: 1
affiliations:
 - name: University of Manitoba
   index: 1
 - name: Hospital for Sick Children
   index: 2
 - name: University of Waterloo
   index: 3
citation_author: Acar et. al.
date: 11 March 2024
year: 2024
bibliography: references.bib
# output: rticles::joss_article
output: bookdown::pdf_document2
csl: apa.csl
journal: JOSS
link-citations: true 
header-includes:
  - \newcommand{\R}{{\textsf{R}}}
---

# Summary

Conditional copula models are multivariate models that allow incorporation of covariates when modelling the dependence structure of multivariate response. While these models can be specified fully parametrically using a parametric copula family with a parametrically specified copula parameter (e.g., linear in covariates), the unknown form of covariate effects on the dependence parameters often entails the use of nonparametric function estimation techniques in practice.   

``LocalCop`` is an \R/ C++ package that utilizes ``TMB`` for a fast implementation of local likelihood inference of the dependence parameter in conditional copula models based on the works @ACY2011, @ACY2013 and @ACL2019. 
``LocalCop`` further offers copula family selection and model tuning for fitting conditional copulas. 



# Statement of Need

There are well-developed \R packages such as ``copula`` [@copula1; @copula2; @copula3; @copula4] and ``VineCopula``[@vinecopula] for simulating from and estimating copulas for various multivariate problems. 
However, these software exclusively focus on unconditional data settings and do not accommodate covariate information. 
The available software for conditional copulas are ``gamCopula`` [@gamcopula] and ``CondCopulas`` [@condcopulas]. The former implements spline smoothing in the context of generalized additive models and the latter offers kernel-based estimators of the conditional Kendall's tau.


# Background

We consider the bivariate random vector $(Y_1, Y_2)$ whose conditional joint distribution given a covariate $X$ is characterized by 
\begin{equation}
F_X(y_1, y_2 \mid x) = C_X (F_{1\mid X} (y_1 \mid x),F_{2\mid X} (y_2 \mid x) ),
\end{equation}
where $F_{1\mid X}\equiv U$ and $F_{2\mid X}\equiv V$ are conditional marginal distributions of $Y_1$ and $Y_2$ given $X$ and $C_X : [0,1]^2 \to [0,1]$ is the conditional copula function.  

Suppose $C_X$ belongs to a parametric copula family $C_X \in \mathcal{C}\{ C(\cdot, \cdot; \theta (X))\}$. Since most parametric copula families have a restricted parameter range, we describe the data generating model in terms of the calibration function $\eta(x)$ and obtain $\theta(x) = g^{-1}(\eta(x))$ where $g^{-1}: \mathbb{R} \to \Theta$ is the inverse link function that ensures that the copula parameter has the correct range. The choice of $g^{-1}$ is not unique and depends on the copula family. The canonical choices for the link function are provided in Table \ref{calib} for the commonly used copula families.


\begin{table}
\begin{center}
\caption{Common copula families and their parameterizations.}
\label{calib}
\scalebox{0.80}{
\begin{tabular}{l c c c c c c}
\hline
\\ 
Family & $ \mathcal{C}(u_1, u_2; \theta,\nu)$  & $\theta \in$ & $\nu \in$ &  $g^{-1}(t)$  & $\tau $
\\
\hline
\\
Gaussian & $\Phi_\theta ( \Phi^{-1}(u), \Phi^{-1}(v))$  
& $(-1,1)$  & - &  $\dfrac{e^{t} - e^{-t}}{e^{t} + e^{-t}}$ & $\dfrac{2}{\Pi}\arcsin(\theta)$ 
\\[2ex]
Student-t & $t_{\theta,\nu} ( t_\nu^{-1}(u), t_\nu^{-1}(v))$ 
& $(-1,1)$  & $(0, \infty)$ &  $\dfrac{e^{t} - e^{-t}}{e^{t} + e^{-t}}$ &
$\dfrac{2}{\Pi}\arcsin(\theta)$ 
\\[2ex]
Clayton & $ \displaystyle (u_1^{-\theta} + u_2^{-\theta} -1)^{-\frac{1}{\theta}} $  
&  $(0, \infty$)  - &
& $e^t$
& $\displaystyle {\theta}/ {(\theta + 2)}$ 
\\[2ex]
Gumbel &$ \displaystyle  \exp\left[ - \{  (-\ln u_1)^\theta + (-\ln u_2)^\theta\}^{\frac{1}{\theta}} \right]$
& $[1, \infty)$ & - & $e^t + 1$
&  $\displaystyle 1 - 1/{\theta}$ 
\\[2ex]
Frank &$ \displaystyle -\frac{1}{\theta}\ln \left\{ 1 + \frac{(e^{-\theta u_1} - 1)(e^{-\theta u_2} - 1)}{e^{-\theta} - 1}\right\}$
&  $(-\infty, \infty)/\{0\}$ & - & t
&  \text{no closed form} 
\\
\\[1ex]
\hline
\end{tabular}
}
\end{center}
\end{table}


The estimation of the conditional copula parameter is based on the local likelihood estimation which uses the Taylor approximation
$$
\eta(X_i)\approx \eta(x_0) + \eta^{(1)}(x_0) (X_i - x_0) + \ldots + \dfrac{\eta^{(p)}(x_0)}{p!} (X_i - x_0)^{p}
$$
to approximate the unknown dependence parameter function at an observed covariate around a fixed point $x_0$. Usually a linear fit with $p=1$ suffices to obtain a good estimate in practice. 

For a given bandwidth parameter and a copula family, one can obtain the estimates of $\beta_k = \eta^{(k)}(\cdot)/k!$, $k=0,\ldots,p$ using a kernel-weighted local likelihood function
$$
\sum_{i=1}^n \log\left\{ c\left(u_i, v_i ; g^{-1} (\mathbf{x}_{i,0}^T \boldsymbol{\beta})\right) \right\} K_h\left(\dfrac{x_i-x_0}{h}\right),
$$
where $\mathbf{x}_{i,0} = (1, x_i-x_0, (x_i-x_0)^2, \ldots, (x_i-x_0)^p)^T$, $\boldsymbol{\beta}= (\beta_0, \beta_1, \ldots, \beta_p)^T$, $K$ is the kernel function and $h$ is the bandwidth parameter. This is implemented in `CondiCopLocFit()`, where the user can specify a set of $x_0$ points and select from different kernel functions. 

# Usage

``LocalCop`` is available on [GitHub](https://github.com/mlysy/LocalCop) and [CRAN]() and can be installed and used following the codes below.

```{r}
library(LocalCop)
```

```{r libs, echo=FALSE, message=FALSE}
library(LocalCop)
library(VineCopula) # for simulating copula data 
library(tidyverse)  # for data manipulations
library(ggplot2) # for plots
```

We illustrate the usage of the software through synthetic data generated from the Clayton copula with the conditional Kendall $\tau$ given in Figure \@ref(fig:dgm). 

```{r dgm, echo = FALSE, message=FALSE, fig.align='center', fig.width=7, fig.height=5, fig.cap="Conditional Kendall $\\tau$ for Clayton copula under DGM."}
# simulate copula data given a covariate
set.seed(2024) 
family <- 3  # Clayton Copula 
n <- 300    # number of observations
X <- sort(runif(n))  # covariate values
eta_fun <- function(x){ # calibration function
sin(5*pi*x)+cos(8*pi*x)
}
eta_true <- eta_fun(X)
par_true <- BiCopEta2Par(family = family, eta = eta_true) # copula parameter
udata <- VineCopula::BiCopSim(n, family = family, par = par_true$par)
tau_true <- VineCopula::BiCopPar2Tau(family, par = par_true$par)
plot(X, tau_true, type = "l", lwd=2, ylim=c(-0.5,1), ylab=expression(tau("x")))

```


```{r select1, message=FALSE}
bandset <- c(0.1, 0.12, 0.15, 0.18, 0.2, 0.5, 0.8, 1) # bandwidth set
famset <- c(1, 2, 3, 4, 5) # family set
xind <- 100  # number of leave-one-out observations in CV likelihood calculation
system.time({
  cvselect <- CondiCopSelect(u1= udata[,1], u2 = udata[,2],
                             X = X, family = famset, band = bandset,
                             xind = xind)
})
(cv_res <- cvselect$cv)

i_opt <- which.max(cv_res$cv)
fam_opt <- cv_res[i_opt,]$family
band_opt <- cv_res[i_opt,]$band

x0 <- seq(0, 1, by=0.01)
fitseq <- CondiCopLocFit(u1 = udata[,1], u2 = udata[,2], 
                         family = fam_opt, X = X, x = x0, 
                         degree = 1, band = band_opt)
plot(X, tau_true, type = "l", lwd=2, ylim=c(-0.5,1), ylab=expression(tau("x")))
lines(x0, BiCopEta2Tau(fitseq$eta, family= family), col=2, lwd = 2, lty=2)

# compare with  gamCopula
gam_res <- gamCopula::gamBiCopSelect(udata[,1:2], smooth.covs = as.data.frame(X))$res
gam_tau <- gamCopula::gamBiCopPredict(gam_res, X, target = "tau")$tau
lines(X, gam_tau, col = 3, lty = 2, lwd = 1.5)

# compare with CondCopulas
par_est <- CondCopulas::estimateParCondCopula(udata[,1], udata[,2], X, x0, family= fam_opt,
  method = "mle", h=band_opt)
tau_est <- VineCopula::BiCopPar2Tau(family= fam_opt, par_est)
lines(x0, tau_est, col = 4, lty = 2, lwd = 1.5)

```

## Session Info

```{r session, echo = FALSE}
sessionInfo()
```

# Acknowledgements

We acknowledge funding support from the Natural Sciences and Engineering Research Council of Canada ()

# References
